---
title: "Exercise 5"
date: "12/6/2018"
params:
  studentID: "你的學號（留意要與studentID:間空一格）"
  studentName: "你的名字（留意要與name:間空一格）"
  repoURL: "這個作業的GitHub repo網址（選填）"
---
存檔時，請用你的學號當延伸檔名。例如：若你的學號為41078392，則請`File->Save As...`存成Exercise5-41078392.Rmd。

repoURL若有，老師要給你建議時會更容易，但不強迫。

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr); library(stringr); library(lubridate); library(purrr)
```

# 1. 成績資料分析

資料引入：
```{r}
library(readr)
transcriptData <- read_csv("https://raw.githubusercontent.com/tpemartin/github-data/master/transcript100_102.csv")
```

此資料為台北大學100-102學年入學學生之去識別化成績資料（入學年為資料中的**學屆**欄位）。

## 1.1 單一學號子樣本
取出學號d55dP1052的子樣本：

```{r ans11}
transcriptData[transcriptData$學號=="d55dP1052",]->subsample
```

```{r}
transcriptData %>%
  filter(學號=="d55dP1052") -> subsample
```


## 1.2 總學分數
我們可以透過以下步驟計算他的「總修習學分數」及「總實得學分數」：

```{r}
subsample$學期成績 >= 60 -> subsample$及格 # 1
總修習學分數=sum(subsample$學分數) # 2
總實得學分數=sum(subsample$學分數[subsample$及格]) #3
```

請用dplyr函數改寫以上三個步驟：使用`mutate()`完成#1，接著用`summarise()`完成#2及#3
```{r ans12}
subsample %>%
  mutate(
    及格=(學期成績>=60)
  ) -> subsample2
subsample2 %>%
  summarise(
    總修習學分數=sum(學分數),
    總實得學分數=sum(學分數[及格])
  ) -> summarisedSubsample2
```

## 1.3 summarise應用

上述`summarise()`的最後輸出只會有「總修習學分數」及「總實得學分數」，若為方便讀者閱讀想讓最後輸出還有「學號」,我們可以在`summarise()`裡再加一行`學號=...`（...請自行判斷其程式內容）。

重寫上一題，但讓summarise輸出「學號」、「總修習學分數」、「總實得學分數」三項值。

```{r ans13}
subsample %>%
  mutate(
    及格=(學期成績>=60)
  ) -> subsample2
subsample2 %>%
  summarise(
    學號=學號[1],
    總修習學分數=sum(學分數),
    總實得學分數=sum(學分數[及格])
  ) -> summarisedSubsample2New
```

## 1.4 學分數計算函數

設計一個學分數計算函數稱之為totalCredits，當我們給它學號字串，它便會回傳給我們「學號」、「總修習學分數」、「總實得學分數」三項值。以上題為例,`totalCredits("d55dP1052")`會回傳上題答案值。

```{r}
totalCredits<-function(x){
  #transcriptData[transcriptData$學號==x,]->subsample 
  transcriptData %>%
    filter(學號==x) %>%
    mutate(
      及格=(學期成績>=60)
    ) %>%
    summarise(
      學號=學號[1],
      總修習學分數=sum(學分數),
      總實得學分數=sum(學分數[及格])
    ) -> finalResult
  return(finalResult)
}
```

## 算每個學生學分數

```{r}
transcriptData$學號 %>% unique -> allStudentID
allStudentCredits<-vector("list",length(allStudentID))
#i<-3
for(i in seq_along(allStudentID)){
  studentID_i<-allStudentID[i]
  studentID_i %>% totalCredits ->
    allStudentCredits[[i]]
}
```

map(x,function(x[i]))

```{r}
x<-seq_along(allStudentID)
x
```

map(c(1,2,....,2803),function(i))

```{r}
i<-3
totalCreditsOfStudent_i<-function(i){
  allStudentID[i] %>% totalCredits
}
answerList<-map(seq_along(allStudentID),totalCreditsOfStudent_i)
```


```{r}
totalCredits
```

## 1.5 取出系別代號

學號的第5-6碼為此學生系別, 請在transcriptData新增**系別**欄位。
```{r ans15}
transcriptData$學號 %>% str_sub(5,6) -> transcriptData$系別
```


## 1.6 通識科目總類

找出此樣本中100學年第1學期學生所選通識科目有那幾種。最後一行程式請存在**通識科目總表**物件裡，裡頭是「不重覆」的科目名稱。
（hint: 由於每個科目可以有很多學生修，取出每位學生修的通識會有不少重覆，此時可以用`unique()`函數去掉重複的部份即是完整的科目種類。）
```{r}
(transcriptData$學年==100 & 
   transcriptData$學期==1 &
   transcriptData$`必選修類別（必∕選∕通）`=="通") -> filteredLogiIndex
transcriptData[filteredLogiIndex,]$科目名稱 %>% unique -> 通識科目總表
```

## 1.7 課堂學生系別背景多樣化

欲了解一堂課的學生系別背景多樣化，我們可進行生物學上的Shannon index計算，公式說明如下：

  1. 計算該堂課學生來自不同系別的比例，例如：有10個學生，3個來自A系，2個B系，5個C系，則比例為`c(3/10,2/10,5/10)`
  
  2. 假設p為此比例向量，則Shannon index為`-sum(p*log(p))`
  
我們用以下例子來了解上面的程式公式： 若`p <- c(0.3,0.2,0.5)`則`log(p)<-c(log(0.3),log(0.2),log(0.5))`且`p*log(p)`會是`c(0.3*log(0.3),0.2*log(0.2),0.5*log(0.5))`，`-sum`則把前者三元素值相加再取負號。

請建立一個函數稱之為shannon（s請用小寫），它的input argument x為課程學生的系別——給它一連串學生的系別，此函數便會計算出該課的學生系別背景多樣化指標值。
  
  
```{r ans17}
shannon<-function(x){
  x %>% table %>%
    {./sum(.)} -> p
  -sum(p*log(p)) -> ShannonIndex   
  return(ShannonIndex)
}
```


## 1.8 課程學生系別背景多樣化

請選出105學年第2學期有修通識科目FU20的學生系別，再透過先前創造的`shannon()`來計算該課程的學生系別背景多樣性指標值。
```{r ans18}
(transcriptData$學年==105 & 
   transcriptData$學期==2 & transcriptData$科目名稱=="FU20") -> filteredLogiIndex
transcriptData$系別[filteredLogiIndex] %>% shannon
```

> Shannon index值越高表示學生系別背景越多樣化。